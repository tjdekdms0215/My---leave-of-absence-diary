// 1. ìˆ¨ê²¨ë‘” .env íŒŒì¼ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì½ì–´ì˜¤ê¸° ìœ„í•œ ë§ˆë²•ì˜ ì£¼ë¬¸
require('dotenv').config(); 

const express = require('express');
const Post = require('./models/Timeline');
const cors = require('cors');
// 2. ëª½ê³ DBì™€ ì—°ê²°í•´ì£¼ëŠ” ë²ˆì—­ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
const mongoose = require('mongoose'); 

const bcrypt = require('bcrypt'); // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë„êµ¬
const User = require('./models/User'); // ì•„ê¹Œ ë§Œë“  ìœ ì € ì„¤ê³„ë„
const jwt = require('jsonwebtoken');
const Timeline = require('./models/Timeline');

const app = express();
app.use(express.json()); // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì˜¤ëŠ” JSON ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìžˆê²Œ í•´ì£¼ëŠ” ë§ˆë²•ì˜ ì½”ë“œ
const port = process.env.PORT || 3000;

app.use(cors({
    origin: 'https://tjdekdms0215.github.io', // ë‹¤ì€ë‹˜ì˜ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ!
    credentials: true // ë‚˜ì¤‘ì— ë¡œê·¸ì¸ ìœ ì§€í•  ë•Œ í•„ìš”í•´ìš”
}));

// 4. ðŸŒŸ ëª½ê³ DB(ìš°ë¦¬ì˜ ê¸ˆê³ )ì™€ ì‹¤ì œë¡œ ì—°ê²°í•˜ëŠ” ì½”ë“œ
mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log('âœ… ëª½ê³ DB ê¸ˆê³ ì— ë¬´ì‚¬ížˆ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!'))
  .catch((err) => console.log('âŒ ëª½ê³ DB ì—°ê²° ì‹¤íŒ¨:', err));

// ==========================================
// ðŸŒŸ íšŒì›ê°€ìž… API (POST ìš”ì²­)
// ==========================================
app.post('/api/signup', async (req, res) => {
    try {
        // 1. ìœ ì €ê°€ ë³´ë‚¸ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ êº¼ë‚´ê¸°
        const { username, password } = req.body;

        // 2. ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” ì•„ì´ë””ì¸ì§€ ê¸ˆê³ ì—ì„œ ì°¾ì•„ë³´ê¸°
        const existingUser = await User.findOne({ username });
        if (existingUser) {
            return res.status(400).json({ message: "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ìž…ë‹ˆë‹¤." });
        }

        // 3. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” (ìˆ«ìž 10ì€ '10ë²ˆ ê¼¬ì•„ì„œ ë³µìž¡í•˜ê²Œ ë§Œë“¤ì–´ë¼'ëŠ” ëœ»!)
        const hashedPassword = await bcrypt.hash(password, 10);

        // 4. ê¸ˆê³ ì— ë„£ì„ ìƒˆë¡œìš´ ìœ ì € ì •ë³´ í¬ìž¥í•˜ê¸°
        const newUser = new User({
            username: username,
            password: hashedPassword
        });

        // 5. ê¸ˆê³ ì— ì§„ì§œë¡œ ì €ìž¥!
        await newUser.save();

        // 6. ì„±ê³µí–ˆë‹¤ê³  ë‹µë³€ ë³´ë‚´ê¸°
        res.status(201).json({ message: "íšŒì›ê°€ìž… ì„±ê³µ! í™˜ì˜í•©ë‹ˆë‹¤ ðŸŽ‰" });
        console.log(`ìƒˆë¡œìš´ ìœ ì € ê°€ìž… ì™„ë£Œ: ${username}`);
        
    } catch (error) {
        console.error("íšŒì›ê°€ìž… ì—ëŸ¬:", error);
        res.status(500).json({ message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
    }
});

// ==========================================
// ðŸŒŸ ë¡œê·¸ì¸ API (POST ìš”ì²­)
// ==========================================
app.post('/api/login', async (req, res) => {
    try {
        const { username, password } = req.body;

        // 1. ê¸ˆê³ ì—ì„œ ì•„ì´ë”” ì°¾ê¸°
        const user = await User.findOne({ username });
        if (!user) {
            return res.status(400).json({ message: "ì•„ì´ë””ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
        }

        // 2. ë¹„ë°€ë²ˆí˜¸ê°€ ë§žëŠ”ì§€ ë¹„êµí•˜ê¸° (bcryptê°€ ì™¸ê³„ì–´ ì•”í˜¸ë¥¼ í•´ë…í•´ì„œ ë¹„êµí•´ ì¤ë‹ˆë‹¤!)
        const isMatch = await bcrypt.compare(password, user.password);
        if (!isMatch) {
            return res.status(400).json({ message: "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤." });
        }

        // 3. ë¹„ë°€ë²ˆí˜¸ê°€ ë§žë‹¤ë©´ ìž…ìž¥ê¶Œ(JWT) ë°œê¸‰í•˜ê¸°! (ìœ íš¨ê¸°ê°„: 1ì‹œê°„)
        const token = jwt.sign(
            { userId: user._id }, 
            process.env.JWT_SECRET, 
            { expiresIn: '1h' }
        );

        // 4. ìœ ì €ì—ê²Œ ì„±ê³µ ë©”ì‹œì§€ì™€ ìž…ìž¥ê¶Œ ë³´ë‚´ì£¼ê¸°
        res.json({ message: "ë¡œê·¸ì¸ ì„±ê³µ!", token: token });
        console.log(`ìœ ì € ë¡œê·¸ì¸ ì„±ê³µ: ${username}`);

    } catch (error) {
        console.error("ë¡œê·¸ì¸ ì—ëŸ¬:", error);
        res.status(500).json({ message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
    }
});

// ==========================================
// ðŸ›¡ï¸ í† í° ê²€ì‚¬ì› (ì¸ì¦ ë¯¸ë“¤ì›¨ì–´)
// ==========================================
const authenticateToken = (req, res, next) => {
    // 1. ë°©ë¬¸ìžê°€ ì œì‹œí•œ ìž…ìž¥ê¶Œ(í† í°) í™•ì¸í•˜ê¸°
    const authHeader = req.headers['authorization'];
    // ë³´í†µ í† í°ì€ "Bearer eyJhbG..." í˜•íƒœë¡œ ì˜¤ê¸° ë•Œë¬¸ì— ë’¤ì˜ ì§„ì§œ í† í°ë§Œ ì™ ë¹¼ëƒ…ë‹ˆë‹¤.
    const token = authHeader && authHeader.split(' ')[1];

    // 2. í† í°ì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì«“ì•„ë‚´ê¸°
    if (!token) {
        return res.status(401).json({ message: "ìž…ìž¥ê¶Œ(í† í°)ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    // 3. í† í°ì´ ì§„ì§œì¸ì§€(ìœ„ì¡°ë˜ì§€ ì•Šì•˜ëŠ”ì§€) ìš°ë¦¬ê°€ ì•„ê¹Œ ë§Œë“  ë¹„ë°€ ë„ìž¥ìœ¼ë¡œ í™•ì¸í•˜ê¸°
    jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
        if (err) {
            return res.status(403).json({ message: "ìž…ìž¥ê¶Œì´ ê°€ì§œì´ê±°ë‚˜ ìœ íš¨ê¸°ê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤." });
        }
        
        // 4. ë¬´ì‚¬ížˆ í†µê³¼í–ˆë‹¤ë©´ ìœ ì € ì •ë³´ë¥¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ê²¨ì£¼ê¸°
        req.user = user;
        next(); // "í†µê³¼!" í•˜ê³  ë¬¸ì„ ì—´ì–´ì£¼ëŠ” ì—­í• 
    });
};

// ==========================================
// ðŸ’Ž VIP ì „ìš© êµ¬ì—­ í…ŒìŠ¤íŠ¸ (í† í°ì´ ìžˆì–´ì•¼ë§Œ ì ‘ê·¼ ê°€ëŠ¥)
// ==========================================
// ì£¼ì†Œ ì¤‘ê°„ì— 'authenticateToken' ê²€ì‚¬ì›ì´ ì„œ ìžˆëŠ” ê±° ë³´ì´ì‹œì£ ?
app.get('/api/vip-only', authenticateToken, (req, res) => {
    res.json({ 
        message: "í™˜ì˜í•©ë‹ˆë‹¤! VIP êµ¬ì—­ì— ë¬´ì‚¬ížˆ ìž…ìž¥í•˜ì…¨ìŠµë‹ˆë‹¤ ðŸ’Ž",
        userId: req.user.userId 
    });
});

// ë‹¤ì€ë‹˜ì˜ ì‹¤ì œ íœ´í•™ íƒ€ìž„ë¼ì¸ ë°ì´í„°
const timelineData = [
    {
        id: 1,
        date: "2025.01",
        title: "ë¦¿ì¹˜ í”„ë¡œëª¨ ì´¬ì˜ ðŸ“¸",
        desc: "ë‚˜ì˜ ì•ˆë¬´ ì°½ìž‘, ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ í”„ë¡œëª¨ ì´¬ì˜ ",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 2,
        date: "2025.02",
        title: "ë¶€ì‚° ì—¬í–‰ê³¼ ì•Œë°”ëª¬ì˜ ì‚¶",
        desc: "ë‚¨ìžì¹œêµ¬ì™€ ì²« ì—¬í–‰, ì“°ë¦¬ìž¡ê¹Œì§€ ë›°ì—ˆì–´ì—¬",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 3,
        date: "2025.03",
        title: "í•œí™” ì›ì •ê²½ê¸°ì™€ ë˜ ì•Œë°”,,",
        desc: "í•˜ì—°ì–¸ë‹ˆì™€ ë– ë‚œ í•œí™” ì›ì •ê²½ê¸°, ê²°ê³¼ëŠ”? Hmm~~",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 4,
        date: "2025.04",
        title: "ë„ì¿„ì—¬í–‰, ì•¼êµ¬",
        desc: "í•˜ì—°ì–¸ë‹ˆì™€ ë– ë‚œ ë„ì¿„ì—¬í–‰",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 5,
        date: "2025.05",
        title: "ë§ˆë¼í†¤ê³¼ ì²« í˜¼ì—¬í–‰ ðŸ”¥",
        desc: "ë²„í‚·ë¦¬ìŠ¤íŠ¸ë¥¼ ì´ë¤˜ë˜ 5ì›”!",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 6,
        date: "2025.06",
        title: "ë‚´ ìƒì¼ê³¼ í›„ì¿ ì˜¤ì¹´ ì—¬í–‰",
        desc: "í–‰ë³µí–ˆë˜ ìƒì¼ê³¼ ì²« í›„ì¿ ì˜¤ì¹´!",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 7,
        date: "2025.07",
        title: "ë¬´ë¹ˆì—…, ìºë¦¬ë¹„ì•ˆ ë² ì´, ë˜ë‹¤ì‹œ ì‹œìž‘ëœ ì—°ìŠµ",
        desc: "ì•„ì£¼ ë°”ì˜ë‹¤ ë°”ë¹ ",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 8,
        date: "2025.08",
        title: "í•œëŠ¥ê²€ ì‹œí—˜ê³¼ ì—°ìŠµ",
        desc: "ì˜¤ëžœë§Œì— ê³µë¶€í•˜ë‹ˆê¹Œ ìž¼ì¼ë‹¤ã…Žã…Ž",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 9,
        date: "2025.09",
        title: "ìƒˆë¡œìš´ ì•Œë°”ì™€ ê³µì—°ë“¤~",
        desc: "ë¦¬í—ˆì„¤í•˜ëž´, ê³µì—°í•˜ëž´ ë°”ë¹ ìš”",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 10,
        date: "2025.10",
        title: "ì—¬ìˆ˜, ì œì£¼ë„ë¡œ ë– ë‚˜ìš”~",
        desc: "ì²˜ìŒìœ¼ë¡œ í˜¼ìžì„œ ì œëŒ€ë¡œ ëœ í˜¼ì—¬í–‰ì„ ë– ë‚¬ë‹¤.",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 11,
        date: "2025.11",
        title: "ì •ê¸°ê³µì—°ê³¼ ë‹¨ë°œ, 1ì£¼ë…„",
        desc: "ë§ˆì§€ë§‰ ê³µì—°, ê·¸ë¦¬ê³  ì²« ì„±í˜•ì™¸ê³¼,,",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 12,
        date: "2025.12",
        title: "ë˜ ì•Œë°”, í¬ë¦¬ìŠ¤ë§ˆìŠ¤",
        desc: "ë˜ë˜ ì•Œë°”,, ì•Œë°”ëª¬ì˜ ì‚¶",
        content:"ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 13,
        date: "2026.01",
        title: "ê³„ì ˆí•™ê¸°, ë“œë””ì–´ ì•Œë°”ëª¬ ì²­ì‚°",
        desc: "36.5ë„ëŠ” ì •ë§ ëª…ê°•ìž…ë‹ˆë‹¤",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    },
    {
        id: 14,
        date: "2026.02",
        title: "ì²« ìœ ëŸ½ì—¬í–‰ê³¼ ë³µí•™ì¤€ë¹„",
        desc: "ìš°ë‹¹íƒ•íƒ• í¬ë¥´íˆ¬ê°ˆ í›„ê¸°",
        content: "ì±„ì›Œì§ˆ ë‚´ìš©,,"
    }
];

// ==========================================
// ðŸ“¦ ë°ì´í„° í•œ ë²ˆì— ê¸ˆê³ ë¡œ ì´ì‚¬í•˜ê¸° (ì´ˆê¸° ì„¸íŒ…ìš©)
// ==========================================
app.get('/api/init-timeline', async (req, res) => {
    try {
        // 1. í˜¹ì‹œ ê¸ˆê³ ì— ì˜›ë‚  ë°ì´í„°ê°€ ë‚¨ì•„ìžˆë‹¤ë©´ ì‹¹ ë¹„ì›Œì¤ë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)
        await Timeline.deleteMany({});

        // 2. timelineData ë°°ì—´ì— ìžˆë˜ 14ê°œì˜ ë°ì´í„°ë¥¼ ê¸ˆê³ ì— í•œ ë²ˆì— ì§‘ì–´ë„£ìŠµë‹ˆë‹¤!
        await Timeline.insertMany(timelineData);

        // 3. ì„±ê³µ ë©”ì‹œì§€ ë³´ë‚´ê¸°
        res.send("âœ… 14ê°œì˜ ì¼ê¸° ë°ì´í„°ê°€ ëª½ê³ DB ê¸ˆê³ ë¡œ ë¬´ì‚¬ížˆ ì´ì‚¬ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ðŸŽ‰");
        console.log("ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ!");
    } catch (error) {
        console.error("ë°ì´í„° ì´ì‚¬ ì—ëŸ¬:", error);
        res.status(500).send("ì´ì‚¬ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
});

app.get('/', (req, res) => {
    res.send('ë‹¤ì€ë‹˜ì˜ ë°±ì—”ë“œ ì„œë²„ê°€ ìž˜ ëŒì•„ê°€ê³  ìžˆì–´ìš”!');
});

// ì „ì²´ ì¼ê¸° ëª©ë¡ì„ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
app.get('/api/timeline', async (req, res) => {
  try {
    // Post ëª¨ë¸ì„ ì‚¬ìš©í•´ DBì— ìžˆëŠ” ëª¨ë“  ë°ì´í„°ë¥¼ ì°¾ìŒ
    const posts = await Post.find(); 
    res.json(posts);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." });
  }
});

// íŠ¹ì • IDì˜ ì¼ê¸°ë§Œ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
app.get('/api/timeline/:id', async (req, res) => {
  try {
    const postId = req.params.id;
    // URLì—ì„œ ë„˜ê²¨ë°›ì€ idë¡œ DBì—ì„œ í•´ë‹¹ ì¼ê¸°ë¥¼ ì°¾ìŒ (MongoDBì˜ _id ê¸°ì¤€)
    const post = await Post.findById(postId);

    if (post) {
      res.json(post); // ì°¾ìœ¼ë©´ ê·¸ ì¼ê¸°ë§Œ ë³´ë‚´ì¤Œ
    } else {
      res.status(404).json({ error: "ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
  }
});

// ìƒˆë¡œìš´ ì¼ê¸° ì“°ê¸° (POST) - í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë³´ë‚¸ ë°ì´í„°ë¥¼ DBì— ì €ìž¥í•©ë‹ˆë‹¤.
app.post('/api/timeline', async (req, res) => {
  try {
    // 1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì“´ ì œëª©, ë‚ ì§œ, ì„¤ëª…, ë‚´ìš©ì„ êº¼ëƒ…ë‹ˆë‹¤. (req.bodyì— ë‹´ê²¨ì„œ ì™€ìš”!)
    const { title, date, desc, content } = req.body;

    // 2. DB(MongoDB) ëª¨ë¸ ê·œê²©ì— ë§žì¶° ìƒˆë¡œìš´ ë©ì–´ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.
    const newTimeline = new Timeline({
      title: title,
      date: date,
      desc: desc,
      content: content
    });

    // 3. DBì— ì§„ì§œë¡œ ì €ìž¥! (awaitë¥¼ ì¨ì„œ ì €ìž¥ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì¤ë‹ˆë‹¤.)
    await newTimeline.save();
    
    // 4. ìž˜ ì €ìž¥ë˜ì—ˆë‹¤ê³  í”„ë¡ íŠ¸ì—”ë“œì— ì„±ê³µ ë‹µìž¥ì„ ë³´ëƒ…ë‹ˆë‹¤.
    res.status(201).json({ message: "ì¼ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!", data: newTimeline});
    
  } catch (error) {
    console.error("ì €ìž¥ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
    res.status(500).json({ error: "ì¼ê¸° ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." });
  }
});

app.listen(port, () => {
    console.log(`ì„œë²„ ì‹¤í–‰ ì™„ë£Œ: http://localhost:${port}`);
});