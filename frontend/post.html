<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ê¸° ë³´ê¸° - ì„±ë‹¤ì€ì˜ íœ´í•™ì¼ê¸°</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; padding: 30px; display: flex; justify-content: center; }
        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        .post-date { color: #888; font-size: 14px; margin-bottom: 5px; }
        .post-title { font-size: 28px; color: #333; margin-top: 0; margin-bottom: 10px; }
        .post-desc { color: #555; font-style: italic; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .post-content { font-size: 16px; line-height: 1.6; color: #444; margin-bottom: 40px; white-space: pre-wrap; }
        .comments-section { background-color: #f9f9f9; padding: 20px; border-radius: 8px; }
        .comment-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; }
        .comment-author { font-weight: bold; color: #2196F3; margin-bottom: 5px; font-size: 14px; }
        .comment-text { margin: 0; color: #333; font-size: 15px; }
        .comment-input-area { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; resize: vertical; }
        button { padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #666; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        <div id="post-details">
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div class="comments-section">
            <h3>ğŸ’¬ ëŒ“ê¸€ (<span id="comment-count">0</span>)</h3>
            <div id="comments-list"></div>
            <div id="comment-form-area"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://my-leave-of-absence-diary.onrender.com';
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        document.addEventListener("DOMContentLoaded", () => {
            if (!postId || postId === 'undefined') {
                alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤!");
                window.location.href = 'index.html';
                return;
            }
            loadPostData();
            loadComments();
            setupCommentForm();
        });

        async function loadPostData() {
            try {
                const response = await fetch(`${BASE_URL}/api/timeline/${postId}`);
                if (!response.ok) throw new Error("ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const post = await response.json();

                const postDetailsDiv = document.getElementById('post-details');
                postDetailsDiv.innerHTML = `
                    <div class="post-date">${post.date}</div>
                    <h1 class="post-title">${post.title}</h1>
                    <div class="post-desc">${post.desc}</div>
                    ${post.img ? `<div style="text-align: center; margin-bottom: 20px;"><img src="${post.img}" style="max-width: 100%; border-radius: 8px;"></div>` : ''}
                    <div class="post-content">${post.content || "ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}</div>
                `;
            } catch (error) {
                document.getElementById('post-details').innerHTML = `<p style="color:red;">ì—ëŸ¬: ${error.message}</p>`;
            }
        }

        async function loadComments() {
            try {
                const response = await fetch(`${BASE_URL}/api/comments/${postId}`);
                const comments = await response.json();
                document.getElementById('comment-count').innerText = comments.length;
                const commentsListDiv = document.getElementById('comments-list');
                
                if (comments.length === 0) {
                    commentsListDiv.innerHTML = '<p style="color: #888; text-align: center;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                commentsListDiv.innerHTML = comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-author">ğŸ§‘â€ğŸ’» ${comment.author}</div>
                        <p class="comment-text">${comment.content}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error("ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨:", error);
            }
        }

        function setupCommentForm() {
            const token = localStorage.getItem('token');
            const formArea = document.getElementById('comment-form-area');
            if (token) {
                formArea.innerHTML = `
                    <div class="comment-input-area">
                        <textarea id="new-comment" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <button onclick="submitComment()">ëŒ“ê¸€ ë“±ë¡</button>
                    </div>
                `;
            } else {
                formArea.innerHTML = `<p style="text-align:center; font-size:14px; color:#666;">ëŒ“ê¸€ì„ ì“°ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>`;
            }
        }

        async function submitComment() {
            const content = document.getElementById('new-comment').value;
            const token = localStorage.getItem('token');
            if (!content.trim()) return;

            try {
                const response = await fetch(`${BASE_URL}/api/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ postId, content })
                });

                if (response.ok) {
                    document.getElementById('new-comment').value = '';
                    loadComments();
                }
            } catch (error) {
                alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
            }
        }
    </script>
</body>
</html>