<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ê¸° ë³´ê¸° - ì„±ë‹¤ì€ì˜ íœ´í•™ì¼ê¸°</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; padding: 30px; display: flex; justify-content: center; }
        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        
        /* ì¼ê¸° ë‚´ìš© ìŠ¤íƒ€ì¼ */
        .post-date { color: #888; font-size: 14px; margin-bottom: 5px; }
        .post-title { font-size: 28px; color: #333; margin-top: 0; margin-bottom: 10px; }
        .post-desc { color: #555; font-style: italic; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .post-content { font-size: 16px; line-height: 1.6; color: #444; margin-bottom: 40px; white-space: pre-wrap; }
        
        /* ëŒ“ê¸€ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .comments-section { background-color: #f9f9f9; padding: 20px; border-radius: 8px; }
        .comments-section h3 { margin-top: 0; font-size: 18px; color: #333; }
        
        /* ê°œë³„ ëŒ“ê¸€ ë””ìì¸ */
        .comment-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; }
        .comment-author { font-weight: bold; color: #2196F3; margin-bottom: 5px; font-size: 14px; }
        .comment-date { font-size: 12px; color: #999; margin-left: 10px; font-weight: normal; }
        .comment-text { margin: 0; color: #333; font-size: 15px; }

        /* ëŒ“ê¸€ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .comment-input-area { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; resize: vertical; }
        button { padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #45a049; }
        
        /* ë¡œê·¸ì¸ ì•ˆë‚´ ë©”ì‹œì§€ */
        .login-prompt { text-align: center; padding: 20px; background: #e3f2fd; border-radius: 5px; color: #1565c0; font-weight: bold; }
        .login-prompt a { color: #1976d2; text-decoration: underline; }
        
        .back-link { display: inline-block; margin-bottom: 20px; color: #666; text-decoration: none; font-weight: bold; }
        .back-link:hover { color: #333; }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        
        <div id="post-details">
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div class="comments-section">
            <h3>ğŸ’¬ ëŒ“ê¸€ (<span id="comment-count">0</span>)</h3>
            
            <div id="comments-list"></div>

            <div id="comment-form-area"></div>
        </div>
    </div>

    <script>
    // ğŸŒŸ 1. ë°±ì—”ë“œ ì£¼ì†Œ í™•ì¸ (ëì— '/'ê°€ ì—†ëŠ”ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”!)
    const BASE_URL = 'https://my-leave-of-absence-diary.onrender.com';
    
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    console.log("ğŸ“ í˜„ì¬ ê²Œì‹œê¸€ ID:", postId); // ì½˜ì†”ì—ì„œ IDê°€ ì˜ ì°íˆëŠ”ì§€ í™•ì¸ìš©

    document.addEventListener("DOMContentLoaded", () => {
        if (!postId || postId === 'undefined') {
            console.error("âŒ IDê°€ ì—†ê±°ë‚˜ undefinedì…ë‹ˆë‹¤!");
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤!");
            window.location.href = 'index.html';
            return;
        }
        loadPostData();
        // loadComments(); // ëŒ“ê¸€ ê¸°ëŠ¥ì€ ì¼ë‹¨ ì¼ê¸°ë¶€í„° ë¶ˆëŸ¬ì˜¨ ë’¤ì— í™•ì¸í•´ìš”!
    });

    async function loadPostData() {
        try {
            console.log("ğŸ“¡ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...");
            const response = await fetch(`${BASE_URL}/api/timeline/${postId}`);
            
            if (!response.ok) {
                console.error("âŒ ì„œë²„ ì‘ë‹µ ì—ëŸ¬:", response.status);
                throw new Error("ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }

            const post = await response.json();
            console.log("âœ… ë°›ì•„ì˜¨ ë°ì´í„°:", post);

            const postDetailsDiv = document.getElementById('post-details');
            postDetailsDiv.innerHTML = `
                <div class="post-date">${post.date}</div>
                <h1 class="post-title">${post.title}</h1>
                <div class="post-desc">${post.desc}</div>
                ${post.img ? `<div style="text-align: center; margin-bottom: 20px;"><img src="${post.img}" style="max-width: 100%; border-radius: 8px;"></div>` : ''}
                <div class="post-content" style="white-space: pre-wrap;">${post.content || "ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}</div>
            `;
        } catch (error) {
            console.error("âŒ fetch ì—ëŸ¬ ë°œìƒ:", error);
            document.getElementById('post-details').innerHTML = `<p style="color:red;">ì—ëŸ¬: ${error.message}</p>`;
        }
    }
</script>

        // ==========================================
        // ğŸ“– 1. ì¼ê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        // ==========================================
        async function loadPostData() {
            try {
                const response = await fetch(`${BASE_URL}/api/timeline/${postId}`);
                if (!response.ok) throw new Error("ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const post = await response.json();

                const postDetailsDiv = document.getElementById('post-details');
                postDetailsDiv.innerHTML = `
                    <div class="post-date">${post.date}</div>
                    <h1 class="post-title">${post.title}</h1>
                    <div class="post-desc">${post.desc}</div>
                    <div class="post-content">${post.content || "ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}</div>
                `;
            } catch (error) {
                document.getElementById('post-details').innerHTML = `<p style="color:red;">ì—ëŸ¬: ${error.message}</p>`;
            }
        }

        // ==========================================
        // ğŸ’¬ 2. ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        // ==========================================
        async function loadComments() {
            try {
                const response = await fetch(`${BASE_URL}/api/comments/${postId}`);
                const comments = await response.json();
                
                const commentsListDiv = document.getElementById('comments-list');
                document.getElementById('comment-count').innerText = comments.length;
                
                if (comments.length === 0) {
                    commentsListDiv.innerHTML = '<p style="color: #888; text-align: center;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”! âœ¨</p>';
                    return;
                }

                // ëŒ“ê¸€ë“¤ì„ í•˜ë‚˜ì”© ì˜ˆì˜ê²Œ í¬ì¥í•´ì„œ í™”ë©´ì— ë¶™ì´ê¸°
                commentsListDiv.innerHTML = comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-author">
                            ğŸ§‘â€ğŸ’» ${comment.author} 
                            <span class="comment-date">${new Date(comment.createdAt).toLocaleString()}</span>
                        </div>
                        <p class="comment-text">${comment.content}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error("ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }
        }

        // ==========================================
        // âœï¸ 3. ëŒ“ê¸€ ì…ë ¥ì°½ ë³´ì—¬ì£¼ê¸° (ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸)
        // ==========================================
        function setupCommentForm() {
            const token = localStorage.getItem('token');
            const formArea = document.getElementById('comment-form-area');

            if (token) {
                // ë¡œê·¸ì¸ í–ˆìœ¼ë©´: ëŒ“ê¸€ ì“°ëŠ” ì¹¸ê³¼ ë²„íŠ¼ì„ ë³´ì—¬ì¤Œ!
                formArea.innerHTML = `
                    <div class="comment-input-area">
                        <textarea id="new-comment" rows="3" placeholder="ë‹¤ì€ë‹˜ì˜ ì¼ê¸°ì— ë”°ëœ»í•œ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”! ğŸ˜Š"></textarea>
                        <button onclick="submitComment()">ëŒ“ê¸€ ë“±ë¡</button>
                    </div>
                `;
            } else {
                // ë¡œê·¸ì¸ ì•ˆ í–ˆìœ¼ë©´: ë¡œê·¸ì¸í•˜ë¼ëŠ” ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë„ì›€!
                formArea.innerHTML = `
                    <div class="login-prompt">
                        ëŒ“ê¸€ì„ ì‘ì„±í•˜ì‹œë ¤ë©´ <a href="login.html">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        // ==========================================
        // ğŸš€ 4. ì‘ì„±í•œ ëŒ“ê¸€ ì„œë²„ë¡œ ë³´ë‚´ê¸° (ì €ì¥)
        // ==========================================
        async function submitComment() {
            const commentText = document.getElementById('new-comment').value;
            if (!commentText.trim()) {
                alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${BASE_URL}/api/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // ğŸŒŸ í•µì‹¬! ë°±ì—”ë“œì˜ ê²€ì‚¬ì›(authenticateToken)ì—ê²Œ ë‚˜ì˜ ì…ì¥ê¶Œì„ ë³´ì—¬ì¤ë‹ˆë‹¤!
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({
                        postId: postId,
                        content: commentText
                    })
                });

                if (response.ok) {
                    alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰");
                    document.getElementById('new-comment').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                    loadComments(); // ë°©ê¸ˆ ì“´ ëŒ“ê¸€ì´ ë³´ì´ê²Œ ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                } else {
                    const data = await response.json();
                    alert(data.message || "ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("ëŒ“ê¸€ ë“±ë¡ ì—ëŸ¬:", error);
                alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    </script>

</body>
</html>